/**
 * This file is part of the simple-css-tokenizer package.
 *
 * (c) Vjacheslav Trushkin <cyberalien@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
"use strict";(function(_global){var modules={};(function(){class ParseError{constructor(message,css,index){this.message=message;if(typeof index==='number'&&index!==-1){let start=index;let remaining=css.slice(index)+'!';let trimmed=remaining.trim();let end=start+remaining.length-trimmed.length;let code=css.slice(0,end);let line=code.length-code.replace(/\n/g,'').length+1;this.message+=' on line '+line;}}getMessage(){return this.message;}}modules['Error']=ParseError;})();(function(){class Builder{constructor(options){options=options===void 0?{}:options;this.minify=options.minify===void 0?false:options.minify;this.tab=this.minify?'':options.tab===void 0?'\t':options.tab;this.newline=this.minify?'':options.newline===void 0?'\n':options.newline;this.newLineAfterSelector=options.newLineAfterSelector===void 0?true:options.newLineAfterSelector;this.ruleSeparator=this.minify?':':': ';this.selectorsSeparator=this.minify?',':', ';this.ruleModifiers=options.ruleModifiers!==void 0?options.ruleModifiers:['default','important'];}build(tokens){return this._build(tokens,'').trim();}_build(tokens,space){var _this=this;let output='',lastToken=false,level=0;tokens.forEach(function(token){switch(token.token){case'code':output+=space+token.code+_this.newline;break;case'}':level--;space=space.slice(_this.tab.length);output+=space+'}'+_this.newline;break;case'{':if(lastToken==='}'){output+=_this.newline;}if(token.selectors!==void 0){output+=space+token.selectors.join(_this.selectorsSeparator);}else if(token.atRule!==void 0){output+=space+'@'+token.atRule;if(token.atValues&&token.atValues.length){let values=token.atValues.join(_this.selectorsSeparator);output+=values.length?' '+values:'';}}else{output+=space+token.code;}output+=(_this.newLineAfterSelector?_this.newline+space:_this.minify?'':' ')+'{'+_this.newline;if(token.children){output+=_this._build(token.children,space+_this.tab);output+=space+'}'+_this.newline;}else{level++;space+=_this.tab;}break;case'rule':output+=space+token.key+_this.ruleSeparator+token.value;_this.ruleModifiers.forEach(function(mod){if(token[mod]){output+=' !'+mod;}});output+=';'+_this.newline;break;}lastToken=token.token;});return output;}}modules['Builder']=Builder;})();(function(){const ParseError=modules['Error'];const Builder=modules['Builder'];class Tokenizer{static build(tokens,options){return new Builder(options).build(tokens);}constructor(options){options=options===void 0?{}:options;this.splitRules=options.splitRules!==false;this.ignoreErrors=options.ignoreErrors!==false;this.lessSyntax=options.lessSyntax===true;this.ruleModifiers=options.ruleModifiers!==void 0?options.ruleModifiers:['default','important'];}tree(css){this._tokens=this.tokenize(css);let results=this._parseTokens(this._tokens.shift());while(this._tokens.length){if(!this.ignoreErrors){this.errors.push(new ParseError('Unmatched }',this._css,this._tokens[0].index));}results=results.concat(this._parseTokens(this._tokens.shift()));}return results;}tokenize(css){var _this2=this;this._css=css;this._cssLC=css.toLowerCase();this.errors=[];let start=0,words=[],items=[],depth=0,functionDepth=0,expressionDepth=0,blockStart=0,selectorStart=0,error=false,cssLength=this._css.length;let validTokens=['"',"'",'/*','{','}',';','url(','\\'];if(this.lessSyntax){validTokens=validTokens.concat(['(',')','//','@{','#{']);}this._findTokens(validTokens).forEach(function(token){if(token.index<start){return;}let end;switch(token.token){case'//':words.push({type:'text',text:_this2._css.slice(start,token.index),index:start});start=token.index;let end1=_this2._css.indexOf('\n',start+2);let end2=_this2._css.indexOf('\r',start+2);end=end1===-1?end2:end2===-1?end1:Math.min(end1,end2);if(end===-1){start=cssLength;break;}start=end+1;break;case'/*':words.push({type:'text',text:_this2._css.slice(start,token.index),index:start});start=token.index;end=_this2._css.indexOf('*/',start+2);if(end===-1){if(!_this2.ignoreErrors){_this2.errors.push(new ParseError('Missing comment closing statement',_this2._css,start));error=true;}start=cssLength;break;}start=end+2;break;case'\\':words.push({type:'text',text:_this2._css.slice(start,token.index+2),index:start});start=token.index+2;break;case'url(':words.push({type:'text',text:_this2._css.slice(start,token.index),index:start});start=token.index;end=_this2._findEndOfURL(start);if(typeof end!=='number'){words.push({type:'text',text:_this2._css.slice(start,start+3),index:start});if(!_this2.ignoreErrors){_this2.errors.push(new ParseError('Incomplete URL',_this2._css,start));error=true;}start+=3;break;}words.push({type:'url',text:_this2._css.slice(start,end),index:start});start=end;break;case'"':case"'":words.push({type:'text',text:_this2._css.slice(start,token.index),index:start});start=token.index;end=_this2._findEndOfQuotedString(token.token,start);if(end===false){if(_this2.ignoreErrors){words.push({type:'text',text:_this2._css.slice(start,start+1),index:start});start++;}else{_this2.errors.push(new ParseError('Missing closing '+token.token,_this2._css,start));error=true;words.push({type:'code',text:_this2._css.slice(start),index:start});start=cssLength;}break;}words.push({type:'string',text:_this2._css.slice(start,end),index:start});start=end;break;case';':if(functionDepth>0){break;}if(_this2.splitRules){words.push({type:'text',text:_this2._css.slice(start,token.index),index:start});items.push(_this2._checkRule(words,token.token,error));if(error){items[items.length-1].error=true;error=false;}}selectorStart=start=token.index+1;words=[];break;case'{':if(!_this2.splitRules){if(selectorStart>blockStart){let code=_this2._css.slice(blockStart,selectorStart).trim();if(code.length){items.push({token:'code',code:code,index:blockStart});if(error){items[items.length-1].error=true;error=false;}}}}words.push({type:'text',text:_this2._css.slice(start,token.index),index:start});items.push(_this2._checkSelectors(words));if(error){items[items.length-1].error=true;error=false;}blockStart=selectorStart=start=token.index+1;words=[];depth++;break;case'}':if(expressionDepth>0){if(expressionDepth===1&&_this2.splitRules){let found=false,text=_this2._css.slice(start,token.index+1);for(let i=words.length-1;i>=0;i--){if(words[i].beforeExpression){found=true;delete words[i].beforeExpression;if(i===words.length-1){words.push({type:'expression',text:text,index:start});}else{start=words[i+1].index;words=words.slice(0,i+1);words.push({type:'expression',text:text,index:start});}break;}text=words[i].text+text;}if(!found){words.push({type:'expression',text:text,index:start,error:true});}start=token.index+1;}expressionDepth--;break;}if(_this2.splitRules){words.push({type:'text',text:_this2._css.slice(start,token.index),index:start});items.push(_this2._checkRule(words,'',error));if(error){items[items.length-1].error=true;}}else{let code=_this2._css.slice(blockStart,token.index).trim();if(code.length){items.push({token:'code',code:code,index:blockStart});if(error){items[items.length-1].error=true;}}}error=false;items.push({token:'}',index:token.index});error=false;if(!depth&&!_this2.ignoreErrors){_this2.errors.push(new ParseError('Unexpected }',_this2._css,token.index));}depth--;blockStart=selectorStart=start=token.index+1;words=[];functionDepth=0;break;case'(':if(_this2.splitRules){let row={type:'text',text:_this2._css.slice(start,token.index),index:start};if(!functionDepth){row.beforeFunction=true;}words.push(row);start=token.index;}functionDepth++;break;case')':if(functionDepth===1&&_this2.splitRules){let found=false,text=_this2._css.slice(start,token.index+1);for(let i=words.length-1;i>=0;i--){if(words[i].beforeFunction){found=true;delete words[i].beforeFunction;if(i===words.length-1){words.push({type:'function',text:text,index:start});}else{start=words[i+1].index;words=words.slice(0,i+1);words.push({type:'function',text:text,index:start});}break;}text=words[i].text+text;}if(!found){words.push({type:'function',text:text,index:start,error:true});}start=token.index+1;}functionDepth--;if(functionDepth<0){functionDepth=0;}break;case'@{':case'#{':if(_this2.splitRules){let row={type:'text',text:_this2._css.slice(start,token.index+2),index:start};if(!expressionDepth){row.beforeExpression=true;}words.push(row);start=token.index+2;}expressionDepth++;break;}});if(depth>0&&!this.ignoreErrors){this.errors.push(new ParseError('Missing }',this._css,cssLength));}if(this.splitRules){words.push({type:'text',text:this._css.slice(start),index:start});items.push(this._checkRule(words,'',error));if(error){items[items.length-1].error=true;}}else{let code=this._css.slice(blockStart).trim();if(code.length){items.push({token:'code',code:code,index:blockStart});if(error){items[items.length-1].error=true;}}}return items.filter(function(row){return row!==false;});}_findTokens(tokens){var _this3=this;let list=[];tokens.forEach(function(token){let index=0;while(true){index=_this3._cssLC.indexOf(token,index);if(index===-1){return;}list.push({token:token,index:index});index++;}});list.sort(function(a,b){return a.index-b.index;});return list;}_findEndOfQuotedString(quote,start){let nextEscape=this._css.indexOf('\\',start+1),end=this._css.indexOf(quote,start+1);if(end===-1){return false;}while(nextEscape!==-1&&nextEscape<end){if(end===nextEscape+1){end=this._css.indexOf(quote,end+1);if(end===-1){return false;}}nextEscape=this._css.indexOf('\\',nextEscape+2);}return end+1;}_findEndOfURL(start){let index=(start||0)+4,length=this._css.length,next,end;while(index<length){next=this._css.charAt(index);switch(next){case'"':case"'":end=this._findEndOfQuotedString(next,index);if(end===false){return new ParseError('Incomplete string',this._css,index);}end=this._css.indexOf(')',end);return end===-1?new ParseError('Cannot find end of URL',this._css,start):end+1;case' ':case'\t':case'\r':case'\n':index++;break;default:while(true){switch(next){case')':return index+1;case'"':case"'":case'(':case' ':case'\t':case'\r':case'\n':return new ParseError('Invalid URL',this._css,start);default:if(this._css.charCodeAt(index)<32){return new ParseError('Invalid URL',this._css,start);}}index++;if(index>=length){return new ParseError('Cannot find end of URL',this._css,start);}next=this._css.charAt(index);}}}return new ParseError('Cannot find end of URL',this._css,start);}_checkRule(words,extra,ignoreErrors){let pairs=this._findRulePairs(words),value,index;if(typeof pairs==='boolean'){value=this._mergeWords(words)+extra;if(!value.length){return false;}index=words[0].index;if(pairs===false&&!this.ignoreErrors&&!ignoreErrors){this.errors.push(new ParseError('Invalid css rule',this._css,index));}return{token:'code',code:value,index:index};}return pairs;}_mergeWords(words){return words.map(function(word){return word.text;}).join('').trim();}_checkSelectors(words){let selectors=this._getSelectors(words),result={token:'{',code:this._mergeWords(words),index:words[0].index};if(!selectors.length){return result;}if(selectors[0].charAt(0)==='@'){result.atRule=selectors[0].split(/\s+/,1)[0].slice(1);selectors[0]=selectors[0].slice(1+result.atRule.length).trim();result.atValues=selectors;}else{result.selectors=selectors;}return result;}_getSelectors(words){let selectors=[],selector='';words.forEach(function(word){if(word.type!=='text'){selector+=word.text;return;}let list=word.text.split(',');selector+=list.shift();while(list.length>0){selectors.push(selector.trim());selector=list.shift();}});selectors.push(selector.trim());return selectors.filter(function(item){return item.length>0;});}_findRulePairs(words){var _this4=this;let key='',value='',isKey=true,error=false,hasFunction=false,result;words.forEach(function(word){if(error){return;}if(word.type!=='text'){if(isKey){if(!_this4.lessSyntax){error=true;return;}if(word.type==='function'){hasFunction=true;}key+=word.text;return;}value+=word.text;return;}let pairs=word.text.split(':');if(_this4.lessSyntax&&pairs.length>1){pairs.forEach(function(item,index){if(index>0&&(item==='extend'||item.slice(0,7)==='extend(')){pairs[index-1]+=':'+pairs[index];pairs[index]=null;}});pairs=pairs.filter(function(item){return item!==null;});}if(pairs.length>2){error=true;return;}if(pairs.length===2){if(!isKey){error=true;return;}key+=pairs[0];value=pairs[1];isKey=false;return;}if(isKey){key+=word.text;}else{value+=word.text;}});if(error){return false;}if(isKey){return this.lessSyntax?hasFunction||key.trim().slice(0,1)==='@':false;}key=key.trim();value=value.trim();if(!key.length||!value.length){return false;}result={token:'rule',key:key,value:value,index:words[0].index};this.ruleModifiers.forEach(function(word){if(result.value.slice(0-word.length-1).toLowerCase()==='!'+word){result[word]=true;result.value=result.value.slice(0,result.value.length-word.length-1).trim();}});if(!result.value.length){return false;}return result;}_parseTokens(item){let results=[];while(item!==void 0){switch(item.token){case'}':return results;case'{':item.children=this._parseTokens(this._tokens.shift());results.push(item);break;default:results.push(item);}item=this._tokens.shift();}return results;}}modules['Tokenizer']=Tokenizer;})();_global.CATokenizer=modules.Tokenizer;})(typeof window!=="undefined"?window:typeof WorkerGlobalScope!=="undefined"?self:typeof global!=="undefined"?global:Function("return this;")());
